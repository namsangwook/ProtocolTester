//
//  BaseViewController.swift
//  ProtocolTester
//
//  Created by swnam on 2020/07/27.
//  Copyright Â© 2020 dki. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

struct TestCase {
    var name: String
    var method: HTTPMethod = .get
    var result: String = "testing..."
    var request: String = ""
    var response: String = ""
}


class Toast
{
    class private func showAlert(backgroundColor:UIColor, textColor:UIColor, message:String)
    {

        let appDelegate: AppDelegate = UIApplication.shared.delegate as! AppDelegate
        let label = UILabel(frame: CGRect.zero)
        label.textAlignment = NSTextAlignment.center
        label.text = message
        label.font = UIFont(name: "", size: 15)
        label.adjustsFontSizeToFitWidth = true

        label.backgroundColor =  backgroundColor //UIColor.whiteColor()
        label.textColor = textColor //TEXT COLOR

        label.sizeToFit()
        label.numberOfLines = 4
        label.layer.shadowColor = UIColor.gray.cgColor
        label.layer.shadowOffset = CGSize(width: 4, height: 3)
        label.layer.shadowOpacity = 0.3
        label.frame = CGRect(x: appDelegate.window!.frame.size.width, y: appDelegate.window!.frame.size.height - 50, width: appDelegate.window!.frame.size.width, height: 44)

        label.alpha = 1

        appDelegate.window!.addSubview(label)

        var basketTopFrame: CGRect = label.frame;
        basketTopFrame.origin.x = 0;

        UIView.animate(withDuration
            :1.0, delay: 0.0, usingSpringWithDamping: 0.5, initialSpringVelocity: 0.1, options: UIView.AnimationOptions.curveEaseOut, animations: { () -> Void in
                label.frame = basketTopFrame
        },  completion: {
            (value: Bool) in
            UIView.animate(withDuration:1.0, delay: 1.0, usingSpringWithDamping: 0.5, initialSpringVelocity: 0.1, options: UIView.AnimationOptions.curveEaseIn, animations: { () -> Void in
                label.alpha = 0
            },  completion: {
                (value: Bool) in
                label.removeFromSuperview()
            })
        })
    }

    class func showPositiveMessage(message:String)
    {
        showAlert(backgroundColor: UIColor.green, textColor: UIColor.white, message: message)
    }
    class func showNegativeMessage(message:String)
    {
        showAlert(backgroundColor: UIColor(247, 107, 107), textColor: UIColor.white, message: message)
    }
}

class BaseViewController: UIViewController {


    @IBOutlet weak var tableView: UITableView!
    @IBOutlet var btns: [UIButton]!
    @IBOutlet weak var indicator: UIActivityIndicatorView!

    private let manager = Session()
    
    static var totalTestCase: Int = 0
    static var passTestCase: Int = 0

    
    var lists: [TestCase] = []
    var showDetail: [Bool] = []
    var testCaseIndex = 0
    
    let dispatchQueue = DispatchQueue(label: "myQueue", qos: .background)
    
    func getHeaders(method: HTTPMethod) -> HTTPHeaders {
        let uuid = UUID().uuidString
        //        let base64 = "OTA:ota_system".toBase64()
        let credential = Data("OTA:ota_system".utf8).base64EncodedString()

        let headers: HTTPHeaders = [
            "Accept": "application/json",
            "Content-Type": method == .get ? "application/json" : "application/json",
            "authorization": "Basic \(credential)",
            "iptv-lang-type": UserManager.shared.languageCode,
            "iptv-tx-id": uuid,
            "iptv-login-token" : UserManager.shared.loginToken,
            "Deivce-Token": UserManager.shared.deviceToken
        ]
        return headers
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()

        btns.forEach { (btn) in
            btn.layer.borderWidth = 1
            btn.layer.borderColor = UIColor.white.withAlphaComponent(0.3).cgColor
            btn.layer.cornerRadius = btn.frame.size.height / 4
            btn.layer.masksToBounds = true
        }

        self.indicator.isHidden = true
    }
    
    @IBAction func startBtnClicked(_ sender: Any) {
        testInit()
        dispatchQueue.async {
            
            DispatchQueue.main.async {
                self.btns.forEach { (btn) in
                    btn.isEnabled = false
                }
                self.indicator.isHidden = false
                self.indicator.startAnimating()
            }
            self.test()
            DispatchQueue.main.async {
                self.btns.forEach { (btn) in
                    btn.isEnabled = true
                }
                self.indicator.stopAnimating()
                self.indicator.isHidden = true
            }
        }
    }

    @IBAction func resetBtnClicked(_ sender: Any) {
        tableView.reloadData()
    }
    
    @objc func test() {
        fatalError()
    }

    func testInit() {
        lists = []
        showDetail = []
        testCaseIndex = 0

    }
    
    func appendTestCase(name: String) {
        if name.count > 0 {
            lists.append(TestCase(name: name))
            showDetail.append(false)
        }
    }
    
    func getBasicInfo() {
        
        if UserManager.shared.categoryVersion != "0",
            UserManager.shared.overallCategoryId.count > 0,
            UserManager.shared.newReleaseCategoryId.count > 0,
            UserManager.shared.singleVodContentId.count > 0,
            UserManager.shared.seriesVodContentId.count > 0 {
            return
        }

        if let login = loginott(loginId: UserManager.shared.loginId, loginPw: UserManager.shared.loginPw)
        {
            let profiles = login["profile"].arrayValue
            profiles.forEach { (profile) in
                if profile["lastLoginYN"] == "Y" {
                    if profile["lockYN"] == "N" {
                        UserManager.shared.loginToken = login["loginToken"].stringValue
                        UserManager.shared.SAID = login["said"].stringValue
                        UserManager.shared.profileId = profile["profileId"].stringValue
                        return
                    } else {
                        if let profileLogin = profilelogin(profileId: profile["profileId"].stringValue) {
                            UserManager.shared.loginToken = profileLogin["loginToken"].stringValue
                            UserManager.shared.SAID = profileLogin["said"].stringValue
                            UserManager.shared.profileId = profileLogin["profileId"].stringValue
                            return
                        }
                    }
                }
            }
        }
//        guard let login = loginott(loginId: UserManager.shared.loginId, loginPw: UserManager.shared.loginPw) else {
//            return
//        }
//        UserManager.shared.loginToken = login["loginToken"].stringValue
//        UserManager.shared.SAID = login["said"].stringValue
//        UserManager.shared.profileId = login["profile"][0]["profileId"].stringValue
        
//        _ = getprofile()
//
//        if let profileLogin = profilelogin(profileId: UserManager.shared.profileId) {
//            UserManager.shared.loginToken = profileLogin["loginToken"].stringValue
//        }
        
        guard let version = categoryversioncheck() else {
            return
        }
        let rootCategoryId = version["rootCategoryId"].stringValue
        UserManager.shared.categoryVersion = version["version"].stringValue


        guard let categoryRoot = category(categoryId: rootCategoryId) else {
            return
        }

        let homeCategoryId = categoryRoot[0]["categoryId"].stringValue
        

        guard let categoryHome = category(categoryId: homeCategoryId) else {
            return
        }

        let overallCategoryId = categoryHome[0]["categoryId"].stringValue
        UserManager.shared.overallCategoryId = overallCategoryId
        
        guard let overall = category(categoryId: overallCategoryId)
            , let overallList = overall.array else {
                return
        }
        
        overallList.forEach { (content) in
            if content["categoryName"].stringValue == "New Release" {
                UserManager.shared.newReleaseCategoryId = content["categoryId"].stringValue
            }
        }
        
        guard let new = contentlist(categoryId: UserManager.shared.newReleaseCategoryId) else {
            return
        }
        
        guard let contentList = new["contentList"].array else {
            return
        }

        contentList.forEach { (content) in
            if content["isSeries"] == "N" {
                if UserManager.shared.singleVodContentId.count == 0 {
                    UserManager.shared.singleVodContentId = content["contentGroupId"].stringValue
                }
            } else {
                if UserManager.shared.seriesVodContentId.count == 0 {
                    UserManager.shared.seriesVodContentId = content["seriesAssetId"].stringValue
                }
            }
        }
    }
}


extension BaseViewController {
    func requestMBSSynchronous(_ requestUrl: URLConvertible,
                    method: HTTPMethod = .get,
                    parameters: Parameters,
                    index: Int) -> JSON?
    {
        let ds = DispatchSemaphore( value: 0 )
        
        let headers = self.getHeaders(method: method)
        
        
        var data: JSON?
        var resultString = "fail"
        
        self.requestData(requestUrl, method: method, parameters: parameters, headers: headers) { (result, jsonObject, response, error) in
            if index < self.lists.count {
                BaseViewController.totalTestCase += 1
            }
            var requestUrlString = requestUrl
            let headerString = headers.reduce("") { (result, header) -> String in
                result + "\n\t" +  header.description
            }

            let currentDate = Date.now
            let dateString = currentDate.toString(format: "YYYY-MM-dd HH:mm:SS")

            var request = ""
            if method == .get || method == .delete  {
                if let url = response.request?.url {
                    requestUrlString = (String(describing: url))
                }
                request = "* request time : \(dateString)\n* request url : \(requestUrlString)\n* method : \(method.rawValue)\n* headers\(headerString)"

            } else {
                
                var bodyString = String(describing: parameters)
                if let httpBody = response.request?.httpBody,
                    let bodyDesc = String(data: httpBody, encoding: .utf8) {
                    bodyString = bodyDesc
                }
                
                request = "* request time : \(dateString)\n* request url : \(requestUrlString)\n* method : \(method.rawValue)\n* body\n\t\(bodyString)\n* headers\(headerString)"

            }
            
            
            


            if let jsonObject = jsonObject {
                let json = JSON(jsonObject as Any)
                
                
                if index < self.lists.count {
                    self.lists[index].request = request
                    self.lists[index].method = method
                    self.lists[index].response = String(describing: jsonObject)
                }
                if json["returnCode"] == "S" {
                    data = json["data"]
                    resultString = "success"
                    if index < self.lists.count {
                        BaseViewController.passTestCase += 1
                    }
                }
            } else {
                if index < self.lists.count {
                    self.lists[index].request = request
                    self.lists[index].method = method
                    self.lists[index].response = String(describing: error)
                }

            }
            ds.signal()
        }
        ds.wait()
        if index < self.lists.count {
            self.lists[index].result = resultString
            DispatchQueue.main.async {
                self.tableView.reloadData()
            }
            testCaseIndex += 1
        }
        

        return data
    }
    
    
    
//    typealias completionClosure = (JSON) -> Void
//
//    func requestMBS(_ requestUrl: URLConvertible,
//                    method: HTTPMethod = .get,
//                    parameters: Parameters,
//                    completion: completionClosure?,
//                    index: Int)
//    {
//
//        let headers = self.getHeaders(method: method)
//        self.requestData(requestUrl, method: method, parameters: parameters, headers: headers) { (result, jsonObject, response, error) in
//            guard let jsonObject = jsonObject else {
//                self.lists[index].result = "fail"
//                DispatchQueue.main.async {
//                    self.tableView.reloadData()
//                }
//                return
//            }
//            let json = JSON(jsonObject as Any)
//
//            let request = "request url: \(requestUrl)\nmethod: \(method)\nparams : \(String(describing: parameters))\nheaders: \(String(describing: headers))"
//            self.lists[index].request = request
//
//            self.lists[index].response = String(describing: jsonObject)
//            if json["returnCode"] == "S" {
//                if let completion = completion {
//                    let data = json["data"]
//                    self.lists[index].result = "success"
//                    DispatchQueue.main.async {
//                        self.tableView.reloadData()
//                    }
//                    completion(data)
//                    //                    semaphore.signal()
//                } else {
//                    self.lists[index].result = "success"
//                    DispatchQueue.main.async {
//                        self.tableView.reloadData()
//                    }
//                }
//            } else {
//                self.lists[index].result = "fail"
//                DispatchQueue.main.async {
//                    self.tableView.reloadData()
//                }
//            }
//        }
//    }
    
}

extension String {
    func stringByAddingPercentEncodingForRFC3986() -> String? {
        let unreserved = "-._~/?"
//        let unreserved = "-._~?"
        let allowed = NSMutableCharacterSet.alphanumeric()
        allowed.addCharacters(in: unreserved)
        return addingPercentEncoding(withAllowedCharacters: allowed as CharacterSet)
    }
}

extension BaseViewController {
    func requestData(_ convertible: URLConvertible,
                     method: HTTPMethod = .get,
                     parameters: Parameters? = nil,
                     headers: HTTPHeaders? = nil,
                     completion: @escaping (Bool, Dictionary<String, Any>?, AFDataResponse<Data>, NSError?) -> Void)
    {
//        let semaphore = DispatchSemaphore(value: 0)
        
//        var urlParams = ""
//        if let params = parameters {
//            urlParams = params.compactMap({ (key, value) -> String in
//                if var value = value as? String {
//                    value = value.stringByAddingPercentEncodingForRFC3986() ?? value
////                    value = value.replacingOccurrences(of: "/", with: "%2F")
//                    return "\(key)=\(value)"
//                } else {
//                    return "\(key)=\(value)"
//                }
//            }).joined(separator: "&")
//        }
//        let urlRequest = convertible as! String + "?" + urlParams
        
        
        let urlRequest = convertible
        
        manager.request((method == .get || method == .delete) ? urlRequest : convertible,
                        method: method,
                        parameters: (method == .get || method == .delete) ? parameters : parameters,
                        encoding: (method == .get || method == .delete) ? URLEncoding.queryString : JSONEncoding.default,
                        headers: headers)
            .validate(statusCode: 200..<300)
            .responseData { (response: AFDataResponse<Data>) in
                if let url = response.request?.url {
                    print("\n==========================================================================")
                    print("* request: \(String(describing: url))")
                }
                if method == .post || method == .put {
                    if let httpBody = response.request?.httpBody,
                        let bodyDesc = String(data: httpBody, encoding: .utf8) {
                        print("* httpBody: \(bodyDesc)")
                    }
                }
                
                print(">>> Headers : \(String(describing: headers))")
                guard let data = response.data else {
                    completion(false, nil, response, nil)
                    Logger.log("data is nil")
                    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n")
//                    semaphore.signal()
                    return
                }
                
                if let text = String(data: data, encoding: .utf8) {
                    print("* response : \(text)")
                    print("==========================================================================\n")

                }
                
                do {
                    if let jsonDic = try JSONSerialization.jsonObject(with: data, options : .allowFragments) as? Dictionary<String, Any>
                    {
                        //                        print(jsonDic) // use the json here
                        completion(true, jsonDic, response, nil)
                        //                        if let dt = jsonDic["data"] as? Dictionary<String, Any> {
                        //                            if let list = dt["list"] as? Array<Any> {
                        //                                print(list.count)
                        //
                        //                            }
                        //                        }
//                        semaphore.signal()
                    } else {
                        completion(false, nil, response, nil)
                        Logger.log("bad json")
//                        semaphore.signal()
                    }
                } catch let error as NSError {
                    completion(false, nil, response, error)
                    Logger.log(String(describing: error))
                    if let res = response.response {
                        Logger.log(String(describing: res))
                    }
//                    semaphore.signal()
                    
                }
        }
        
        // Wait until the previous API request completes
//        semaphore.wait()

    }
}

extension BaseViewController: UITableViewDelegate, UITableViewDataSource {
//    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
//        return 50
//    }
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        tableView.deselectRow(at: indexPath, animated: true)
        showDetail[indexPath.row] = !showDetail[indexPath.row]
        tableView.reloadRows(at: [indexPath], with: .automatic)
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return lists.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: "ResultCell", for: indexPath) as! ResultCell
        let proto = lists[indexPath.row]
        cell.data = proto
        cell.showDetail = showDetail[indexPath.row]
        return cell
    }
}


// MARK: - MBS
extension BaseViewController {
    func loginott(name: String = "", loginId: String, loginPw: String, loginToken: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/loginott"
        var params = [
            "deviceToken": UserManager.shared.deviceToken,
            "loginId": loginId,
            "loginPw": loginPw.sha256()
        ]
        if loginToken.count > 0 {
            params = [
                "deviceToken": UserManager.shared.deviceToken,
                "loginToken": loginToken,
                "loginId": "",
                "loginPw": ""
            ]
        }
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func getprofile(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/getprofile"
        let params = [
            "said": UserManager.shared.SAID
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func profilelogin(name: String = "", profileId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/profilelogin"
        let params = [
            "deviceToken": UserManager.shared.deviceToken,
            "loginId": UserManager.shared.loginId,
            "said": UserManager.shared.SAID,
            "profileId": profileId,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func profileCreate(name: String = "", profileName: String, profilePic: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/profile"
        let params = [
            "said": UserManager.shared.SAID,
            "profileName": profileName,
            "profilePic": profilePic
        ]
        return requestMBSSynchronous(requestUrl, method: .post, parameters: params, index: self.testCaseIndex)
    }

    func profileDelete(name: String = "", profileId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/profile"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": profileId
        ]
        return requestMBSSynchronous(requestUrl, method: .delete, parameters: params, index: self.testCaseIndex)
    }

    
    func checkpincode(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/checkpincode"
        let params = [
            "type": "accountPin", // accountPin or profilePin
            "loginId": UserManager.shared.loginId,
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "pinCode": "0000",
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func changeinfo(name: String = "", profileName: String = "", profilePic: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/profile/changeinfo"
        
        var params: Parameters = Parameters()
        params["said"] = UserManager.shared.SAID
        params["profileId"] = UserManager.shared.profileId
        params["profilePic"] = profilePic
        if profileName.count > 0 {
            params["profileName"] = profileName
        }

        return requestMBSSynchronous(requestUrl, method: .put,  parameters: params, index: self.testCaseIndex)
    }
    
    func accountresetpassword(name: String = "", loginPw: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/accountresetpassword"
        let params = [
            "loginId": UserManager.shared.loginId,
            "loginPw": loginPw.sha256(),
        ]
        return requestMBSSynchronous(requestUrl, method: .put,  parameters: params, index: self.testCaseIndex)
    }
    
    func categoryversioncheck(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/categoryversioncheck"
        let params = [
            "deviceType": UserManager.shared.deviceType,
            "version": UserManager.shared.categoryVersion
            
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func category(name: String = "", categoryId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/category"
        let params = [
            "version": UserManager.shared.categoryVersion,
            "said": UserManager.shared.SAID,
            "language": UserManager.shared.languageCode,
            "deviceType": UserManager.shared.deviceType,
            "categoryId": categoryId
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
        
    }
    
    func contentlist(name: String = "", categoryId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/contentlist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "categoryId": categoryId,
            "startNo": "0",
            "contentCnt": "20",
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func bannerList(name: String = "", bannerId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/bannerlist"
        let params = [
            "said": UserManager.shared.SAID,
            "bannerPositionId": bannerId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func recentlyWatching(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/recentwatchinglist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func vodwithpackage(name: String = "", contentId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/vodwithpackage"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "contentId": contentId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func packagedetail(name: String = "", offerId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/packagedetail"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "offerId": offerId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func serieslist(name:String = "", seriesId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/serieslist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "seriesAssetId": seriesId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func seasonlist(name:String = "", seriesId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/seasonlist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "seriesAssetId": seriesId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func nodeip(name:String = "", contentType: String = "VOD", contentPath: String, movieId: String, payYn: Bool, resumeYn: Bool) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/nodeip"
        
        var params = Parameters()
        params["said"] = UserManager.shared.SAID
        params["profileId"] = UserManager.shared.profileId
        params["contentType"] = contentType
        params["contentPath"] = contentPath
        params["movieId"] = movieId
        params["payYn"] = payYn ? "Y" : "N"
        params["resumeYn"] = resumeYn ? "Y" : "N"
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func channellist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/channellist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
//            "said": "",
//            "profileId": "",
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func popularchannel(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/popularchannel"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func favoritechannel(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/favoritechannel"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func channelproductinfo(name: String = "", channelId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/channelproductinfo"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
            "channelId": channelId
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func watchinginfo(name: String = "", channelId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/watchinginfo"
        var params = Parameters()
        params["said"] = UserManager.shared.SAID
        params["profileId"] = UserManager.shared.profileId
        params["deviceType"] = UserManager.shared.deviceType
        params["uuid"] = UserManager.shared.deviceToken
        let currentDate = Date.now
        let dateString = currentDate.toString(format: "YYYY-MM-dd HH:mm:SS")

        params["list"] = [["channelId": channelId, "entDt": dateString]]
        return requestMBSSynchronous(requestUrl, method: .post, parameters: params, index: self.testCaseIndex)
    }
    
    func epg(name: String = "", channelId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/epg"
        let params = [
            "said": UserManager.shared.SAID,
            "channelId": channelId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func retrieveowncouponhomeinfo(name: String = "", includeCoupons: Bool) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/retrieveowncouponhomeinfo"
        let params = [
            "said": UserManager.shared.SAID,
            "includeCoupons": includeCoupons ? "Y" : "N",
            "profileId": UserManager.shared.profileId,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func vodlikeGet(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/vodlike"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, method: .get, parameters: params, index: self.testCaseIndex)
    }
    
    func vodlikePost(name: String = "", contentId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/vodlike"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "type": "VOD",
            "contentId": contentId
        ]
        return requestMBSSynchronous(requestUrl, method: .post, parameters: params, index: self.testCaseIndex)
    }
    
    func vodlikeDelete(name: String = "", contentId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/vodlike"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "contentId": contentId
        ]
        return requestMBSSynchronous(requestUrl, method: .delete, parameters: params, index: self.testCaseIndex)
    }
    
    func purchaselist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/purchaselist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func collectionlist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/collectionlist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func retrieveowncouponlist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/retrieveowncouponlist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "searchTarget": "ALL", // searchTarget [ALL(ì ì²´), THB(Cash), RATE(Discount), EXPIRING(ë§ë£1ë¬ì )]
            "includehistory": "Y", // ì¡°íê¸°ê° í¬í¨ ì¬ë¶(1ë) [true(ì¡°í ê¸°ê° í¬í¨), false]
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func subscriptionlist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/subscriptionlist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    func stopsubscription(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/stopsubscription"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "productId" : "B1001",
            "offerId" : "OF20001"
        ]
        return requestMBSSynchronous(requestUrl, method: .put, parameters: params, index: self.testCaseIndex)
    }
    
    
    func messagelist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/messagelist"
        let params = [
            "said": UserManager.shared.SAID,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func smartdownload(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/smartdownload"
        var params: Parameters = Parameters()
        params["language"] = UserManager.shared.languageCode
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }

    func retrieveproductcouponlist(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/retrieveproductcouponlist"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "language": UserManager.shared.languageCode,
        ]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
    func requestpromotioncouponnumberregister(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/requestpromotioncouponnumberregister"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "couponNumber": "010350304144001",
        ]
        return requestMBSSynchronous(requestUrl, method: .post, parameters: params, index: self.testCaseIndex)
    }
    
    func purchasecoupon(name: String = "") -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/purchasecoupon"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "offerId" : "1005",
            "totalPrice" : "100",
            "paymentMethod" : "06"
        ]
        return requestMBSSynchronous(requestUrl, method: .post, parameters: params, index: self.testCaseIndex)
    }
    
    func purchaselisthidden(name: String = "", offerId: [String]) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/purchaselisthidden"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "offerId" : offerId,
            ] as [String : Any]
        return requestMBSSynchronous(requestUrl, method: .put, parameters: params, index: self.testCaseIndex)
    }
    
    func collectionlisthidden(name: String = "", offerId: String) -> JSON? {
        appendTestCase(name: name)
        let requestUrl = Defines.baseUrl + "/collectionlisthidden"
        let params = [
            "said": UserManager.shared.SAID,
            "profileId": UserManager.shared.profileId,
            "offerId" : offerId,
            ] as [String : Any]
        return requestMBSSynchronous(requestUrl, method: .put, parameters: params, index: self.testCaseIndex)
    }
}


extension BaseViewController {
    func totalSearch(name: String = "",
                     contentsType: String, // ì»¨íì¸ ì í 0xFF, 0x00: íµí©ê²ì, 0x01: VOD ê²ì, 0x02: ì¤ìê°ì±ë ê²ì
        sortType: String?, // 1: ì¤ë¦ì°¨ì, 0: ë´ë¦¼ì°¨ì
        searchPosition: String = "0", // ìììì¹(0ë¶í°)
        searchCount: String = "20", // íì´ì§ë¹ ë°íê°ì
        searchWord: String, // ê²ìì´
        sortFields: String? = nil, // ì ë ¬íëì ë³´, pro_name ì ëª©ì, broad_time ììì¼ì
        cate: String? = nil, // ì¥ë¥´ì í´ë¹íë ì¹´íê³ ë¦¬ ê°(í¹ì  ì¹´íê³ ë¦¬ íí°ë§) Ex) 4200(null ì¼ ê²½ì° ì ì²´ vod ê²ì)
        product_id: String, // ê°ìì ìíì¢ë¥ì½ë â ìë¹ì¤ê°ë¥ì±ë + ë¶ê°ì±ë Ex) 2P02 ìí¼ì½ëë³ íí°ë§ì ë³´ë¡ íì©
        adult_yn: String? = nil, // ì±ì¸ ì¬ë¶ Ex) true : ì±ì¸ false: ì±ì¸ ìë null ì¼ ê²½ì° default=true
        exposure_time: String = "24", // ë¸ì¶ìê° Ex) 24 (ì±ë ê²ìììë§ ì¬ì©)
        won_yn: String? = nil // ì ë¬´ë£ íí°ë§ ì¡°ê±´, Y : ì ë£ë§ íí°ë§, N : ë¬´ë£ë§ íí°ë§,ìì : ì ì²´ ê²ì
    ) -> JSON?
    {
        appendTestCase(name: name)
        let requestUrl = Defines.searchUrl + "/totalSearch"
        
        var params: Parameters = Parameters()
        params["contents_type"] = contentsType
        params["sortType"] = sortType
        params["searchPosition"] = searchPosition
        params["searchCount"] = searchCount
        params["searchWord"] = searchWord
        params["sortFields"] = sortFields
        params["cate"] = cate
        params["product_id"] = product_id
        params["adult_yn"] = adult_yn
        params["sa_id"] = UserManager.shared.SAID
        params["device_Type"] = UserManager.shared.deviceType
        params["exposure_time"] = exposure_time
        params["STB_VER"] = UserManager.shared.appVersion
        params["won_yn"] = won_yn
        params["TRANSACTION_ID"] = UserManager.shared.deviceToken
        params["langType"] = UserManager.shared.languageCode
//        let params = [
//            "said": UserManager.shared.SAID,
//            "profileId": UserManager.shared.profileId,
//            "offerId" : offerId,
//            ] as [String : Any]
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    

    func trendWord(name: String = "", productId: String = "") -> JSON? {
        
        appendTestCase(name: name)
        let requestUrl = Defines.searchUrl + "/trendWord"

        var params: Parameters = Parameters()
        params["sa_id"] = UserManager.shared.SAID
        params["product_id"] = productId
        params["appID"] = UserManager.shared.deviceType
        params["STB_VER"] = UserManager.shared.appVersion
        
        return requestMBSSynchronous(requestUrl, parameters: params, index: self.testCaseIndex)
    }
    
}

extension BaseViewController {
    
    // ì°ê´ì¶ì²(ì»¨íì¸  ì°ê´ì¶ì²)
    func recomm(name: String = "",
                CONTENT: String, // ì¶ì² Content Type, VOD : Video
        REC_TYPE: String, // ì¶ì² ìì²­ ì í, ITEM_VOD : ìì´í ê¸°ë° VODì¶ì²
        REC_GB_CODE: String?, // ìì¸ë³´ê¸°/ì¢ë£ì ì¶ì² êµ¬ë¶, M : ìì¸ë³´ê¸° ì¶ì², â» ë¯¸ì¤ì  ì Default : M
        PRODUCT_LIST: String, // ê°ììíID, ê°ììì ê°ì ìí ID. ê°ì ìíì´ ì¬ë¬ ê° ììëë â,âë¡ êµ¬ë¶ í©ëë¤.
        REQ_DATE: String, // ìì²­ ìê°, íì: YYYYMMDDHHmmSS, HH ìê°ì 24ìê° íì. ì) 20120910010133 /  20120910130133
        CONS_ID: String?, // ì»¨íì¸  ID, íì¬ ì´ì©ì¤ì¸ ì½íì¸  ID.
        CAT_ID: String?, // ì°¨ììì¹´íê³ ë¦¬, ì°¨ìì ì¹´íê³ ë¦¬. ìì©ì¶ì² ì ì¹´íê³ ë¦¬ ì íì ê¸°ì¤ì´ ëë¤. ëª¨ë  ìë¹ì¤ììë í´ë¹ ê°ì ì¤ì  í´ì¼ íë¤.
        CAT_TYPE: String,   // ì°¨ììì¹´íê³ ë¦¬ì íì ì¶ì² ì ì±ì¸ì¹´íê³ ë¦¬(19+) ì¶ì² ë´ì­ í¬í¨ ì¬ë¶ ì¤ì . 19+ ì»¨íì¸  ì¶ì²ì ìíì§ ìì ê²½ì°,
        // í´ë¹ê°ì âAdultâ ì´ì¸ì ê°ì ì¤ì  íë©´ 19+ì»¨íì¸ ê° ì ì¸ëê³  ì¶ì² ë©ëë¤.
        // 19+ ì»¨íì¸  ì¶ì²ì´ í¬í¨ë ê²°ê³¼ë¥¼ ìíìë©´ âAdultâë¡ ì¤ì  íë©´, ì¶ì² ë´ì­ì ì±ì¸ ë¦¬ì¤í¸ê° ìëë¼ë íí°ë§ íì§ ìê³  ê²°ê³¼ë¥¼ ì ì¡ í©ëë¤.
        // ë¨, MGPë  menu_rating=19,20 ì¼ ê²½ì° Adultë¡ ì ì¡
        // * (ì£¼ì) CAT_TYPE ë³´ë¤ CONS_RATEê°ì´ ì°ì íë¯ë¡, âAdultâë¡ ì¤ì íë©´ CONS_RATEë í­ì Nì¼ë¡ ì¤ì í´ì¼ í¨.
        ITEM_CNT: String, // íë§ë¹ ë¦¬í´ë°ì í­ëª© ê°ì, íë§ ë³ë¡ ìµë í´ë¹ ê°ìë§í¼ì ë¦¬í´, (ë´ë¶ ì²ë¦¬ ìµë ê°ë¥ : 30 ê° )
        CONS_RATE: String?  // 19ì¸ ì´ì ì»¨íì¸  íí°ë§ íëê·¸
        // Y : 19ì¸ ì´ì ì»¨íì¸  íí°ë§íì¬ ì ê±°í¨. (19ì¸ ì´ì ì½íì¸ ë¥¼ ë¯¸ë¸ì¶í¨.)
        // N : 19ì¸ ì´ì ì»¨íì¸  íí°ë§íì§ ìì. (19ì¸ ì´ì ì½íì¸ ë¥¼ ë¸ì¶í¨.)
        // â» ë¯¸ì ì¡ì Default ê° : App Codeê° I(OTM) : Filtering í¨. ê·¸ì¸ : Filtering íì§ ìì.
    ) -> JSON? {
        
        appendTestCase(name: name)
        let requestUrl = Defines.recommendUrl + "/recomm"
        
        var param: Parameters = Parameters()
        param["CONTENT"] = CONTENT
        param["REC_TYPE"] = REC_TYPE
        param["REC_GB_CODE"] = REC_GB_CODE
        param["SA_ID"] = UserManager.shared.SAID
        param["PRODUCT_LIST"] = PRODUCT_LIST
        param["REQ_DATE"] = REQ_DATE
        param["SVC_CODE"] = UserManager.shared.deviceType
        param["CONS_ID"] = CONS_ID
        param["CAT_ID"] = CAT_ID
        param["CAT_TYPE"] = CAT_TYPE
        param["ITEM_CNT"] = ITEM_CNT
        param["CONS_RATE"] = CONS_RATE
        param["STB_VER"] = UserManager.shared.appVersion
        param["PROFILE_ID"] = UserManager.shared.profileId
        param["LANGTYPE"] = UserManager.shared.languageCode
        
        return requestMBSSynchronous(requestUrl, parameters: param, index: self.testCaseIndex)
    }
    
    // íë ì´ì(ì¬ì©ìê¸°ë° ê°ì¸íì¶ì²)
    func curation(name: String = "",
                  CONTENT: String, // ì¶ì² Content Type, VOD : Video
                     REC_TYPE: String, // ì¶ì² ìì²­ ì í, CURATION : íë ì´ì ì¶ì² ì ë³´
                     PRODUCT_LIST: String, // ê°ììíID, ê°ììì ê°ì ìí ID. ê°ì ìíì´ ì¬ë¬ ê° ììëë â,âë¡ êµ¬ë¶ í©ëë¤.
                     REQ_DATE: String, // ìì²­ ìê°, íì: YYYYMMDDHHmmSS, HH ìê°ì 24ìê° íì. ì) 20120910010133 /  20120910130133
                     CONS_ID: String,
                     MENU_MAX_CNT: Int, // ë¦¬í´ë°ì ë©ë´ ìµëê°ì
                     MENU_MIN_CNT: Int, // ë¦¬í´ë°ì ë©ë´ ìµìê°ì
                     ITEM_MAX_CNT: Int, // ë¦¬í´ë°ì ë©ë´ë¹ ìµë ìì´í ê°ì
                     ITEM_MIN_CNT: Int, // ë¦¬í´ë°ì ë©ë´ë¹ ìµì ìì´í ê°ì
                     CONS_RATE: String?    // 19ì¸ ì´ì ì»¨íì¸  íí°ë§ íëê·¸
                                            // Y : 19ì¸ ì´ì ì»¨íì¸  íí°ë§íì¬ ì ê±°í¨. (19ì¸ ì´ì ì½íì¸ ë¥¼ ë¯¸ë¸ì¶í¨.)
                                            // N : 19ì¸ ì´ì ì»¨íì¸  íí°ë§íì§ ìì. (19ì¸ ì´ì ì½íì¸ ë¥¼ ë¸ì¶í¨.)
                                            // â» ë¯¸ì ì¡ì Default ê° : App Codeê° I(OTM) : Filtering í¨. ê·¸ì¸ : Filtering íì§ ìì.
                     ) -> JSON? {
        
        appendTestCase(name: name)
        let requestUrl = Defines.recommendUrl + "/curation"

        var param: Parameters = Parameters()
        param["CONTENT"] = CONTENT
        param["REC_TYPE"] = REC_TYPE
        param["SA_ID"] = UserManager.shared.SAID
        param["PRODUCT_LIST"] = PRODUCT_LIST
        param["REQ_DATE"] = REQ_DATE
        param["CONS_ID"] = CONS_ID
        param["SVC_CODE"] = UserManager.shared.deviceType
        param["MENU_MAX_CNT"] = MENU_MAX_CNT
        param["MENU_MIN_CNT"] = MENU_MIN_CNT
        param["ITEM_MAX_CNT"] = ITEM_MAX_CNT
        param["ITEM_MIN_CNT"] = ITEM_MIN_CNT
        param["STB_VER"] = UserManager.shared.appVersion
        param["PROFILE_ID"] = UserManager.shared.profileId
        param["LANGTYPE"] = UserManager.shared.languageCode
        
        return requestMBSSynchronous(requestUrl, parameters: param, index: self.testCaseIndex)
    }
    
    // ì¸ê¸°ê¸°ë° ì¶ì² ì»¨íì¸ 
    func topcontent(name: String = "",
                    CONTENT: String, // ì¶ì² Content Type, VOD : Video
        REC_TYPE: String, // ì¶ì² ìì²­ ì í, ITEM_VOD : ìì´í ê¸°ë° VODì¶ì²
        PRODUCT_LIST: String, // ê°ììíID, ê°ììì ê°ì ìí ID. ê°ì ìíì´ ì¬ë¬ ê° ììëë â,âë¡ êµ¬ë¶ í©ëë¤.
        REQ_DATE: String, // ìì²­ ìê°, íì: YYYYMMDDHHmmSS, HH ìê°ì 24ìê° íì. ì) 20120910010133 /  20120910130133
        REQ_CODE: String, // ì¶ì² ìì²­ ì´í êµ¬ë¶, App Code * Appendix A ê° ìë¹ì¤ë³ Code Table ì°¸ì¡°
        CONS_RATE: String?  // 19ì¸ ì´ì ì»¨íì¸  íí°ë§ íëê·¸
        // Y : 19ì¸ ì´ì ì»¨íì¸  íí°ë§íì¬ ì ê±°í¨. (19ì¸ ì´ì ì½íì¸ ë¥¼ ë¯¸ë¸ì¶í¨.)
        // N : 19ì¸ ì´ì ì»¨íì¸  íí°ë§íì§ ìì. (19ì¸ ì´ì ì½íì¸ ë¥¼ ë¸ì¶í¨.)
        // â» ë¯¸ì ì¡ì Default ê° : App Codeê° I(OTM) : Filtering í¨. ê·¸ì¸ : Filtering íì§ ìì.
    ) -> JSON? {
        
        appendTestCase(name: name)
        let requestUrl = Defines.recommendUrl + "/topcontent"
        
        var param: Parameters = Parameters()
        param["CONTENT"] = CONTENT
        param["REC_TYPE"] = REC_TYPE
        param["SA_ID"] = UserManager.shared.SAID
        param["PRODUCT_LIST"] = PRODUCT_LIST
        param["REQ_DATE"] = REQ_DATE
        param["REQ_CODE"] = REQ_CODE
        param["SVC_CODE"] = UserManager.shared.deviceType
        param["CONS_RATE"] = CONS_RATE
        param["STB_VER"] = UserManager.shared.appVersion
        param["PROFILE_ID"] = UserManager.shared.profileId
        param["LANGTYPE"] = UserManager.shared.languageCode
        
        return requestMBSSynchronous(requestUrl, parameters: param, index: self.testCaseIndex)
        
    }
    
}


extension BaseViewController {
    func addLog(_ log: String, extra1: String = "LOG", extra2: String = "LOG") {
        lists.append(TestCase(name: log, method: .get, result: "Log", request: extra1, response: extra2))
        showDetail.append(false)
        testCaseIndex += 1
        DispatchQueue.main.async {
            self.tableView.reloadData()
        }
    }
}
